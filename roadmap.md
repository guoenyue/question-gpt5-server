# 实施计划（详细版）

目标：补全组织/部门管理、实施计划文档与标准 CRUD、权限与回收站兼容、并把导出/统计/异步任务集成到生产流。

阶段 0：需求与数据模型确认（1 周）
- 确认组织/部门层级（平铺 vs 树形）、部门必需字段（code、manager、metadata）。
- 确认权限边界：超级管理员 / 机构管理员 / 部门管理员 / 编辑者 / 查看者。
- 确认回收站策略与永久删除的级联关系（问卷、响应、文件）。

阶段 1：组织与部门基础（1-2 周）
- 实现 organizations 模块（已有）与 departments 模块（树形/parentId 支持），包含：
  - CRUD：创建、修改、删除（软删除）、恢复、永久删除。
  - 列表查询：按 orgId、parentId、关键字搜索、分页。
  - 部门层级查询：可展开为整棵树或按层级获取子节点。
- 组织成员表与 membership 校验（用于替换当前 header 模拟）。
- 更新 RBAC 中间件，校验 membership 与角色。

阶段 2：模板/问卷与回收站集成（1-2 周）
- 回收站统一服务（已实现基础），增强：
  - 支持按资源类型过滤（template/survey/response/file/department）
  - 支持删除原因、操作人、恢复链日志
  - 定期清理策略（cron）
- 永久删除时做级联清理（删除文件、响应、导出记录等）。

阶段 3：异步任务与导出（1-2 周）
- 导出任务完善：
  - Worker 写入 S3，并把导出记录写到 DB（job status, url, size, created_by）
  - 前端查询导出状态并下载
  - 大文件分片/流式产生
- 统计任务：
  - Worker 计算题目维度统计，写回 DB，缓存热数据
  - 支持手动重算与定时重算

阶段 4：安全与运维（1-2 周）
- JWT/OAuth 实现登录与 session 管理
- 对关键操作（导出/永久删除）启用二次确认或 MFA
- 集成监控（Prometheus/Grafana）、日志聚合、备份策略
- 自动化部署（Docker Compose / k8s manifests、CI/CD）

验收标准（每阶段）
- API 文档（Swagger/OpenAPI）覆盖新增接口
- 单元测试覆盖率（关键服务 > 70%）
- 集成测试：主要流程（创建 org -> 创建 dept -> 创建模板 -> 创建问卷 -> 提交响应 -> 导出）
- 性能基线：并发写入与导出队列吞吐测试

风险与缓解
- 高并发响应写入 -> 使用队列与分区/分集群写入
- 永久删除数据误删 -> 采用回滚窗口与审计 + 二次确认